<% require 'pp' %>

<%= render(:partial => 'dialogs/menu') %>

<p>
	<%= select_tag :short_full, options_for_select([['short list','short'],['medium list','medium'],['full list','full']],@short_full), :onchange=>"reload()" %>
	<%= select_tag :less_more, options_for_select([['less info','less'],['more info','more']],@less_more),:style=>"display:#{@short_full=='short' ? "none" : "inline"}",:onchange=>"reload()" %>
	<%= select_tag :regress, options_for_select([['regress to mean','regress'],['raw scores','raw']],@regress),:style=>"display:#{@short_full=='short' ? "none" : "inline"}",:onchange=>"reload()" %>
</p>

<% if false and @regmean -%>
<h3>Regression to the Mean</h3>
<p>Interest: avg: <%= @avg_votes_int %> votes of <%= @avg_interest %><br>
Approval: avg: <%= @avg_votes_app %> votes of <%= @avg_approval %></p>
<% end -%>

<% if @short_full=='full' -%>
<h2>Overall<%= " winner" if not @all %></h2>
<% else -%>
<h2>Voice of Humanity as One</h2>
<% end -%>

<% if false %>chosen by all voters (<%= @data[0]['items'].length %> items, <%= @data[0]['ratings'].length %> votes)<% end %>

<div>
<% for item_id,i in @data[0]['itemsproc'] -%>
<a href="/items/<%= item_id %>/view" style="font-size:14px;font-weight:bold"><%= i['subject'] || "no subject" %></a> <% if @less_more=='more' %>author: <a href="/participant/<%= i['id'] %>/profile"><%= i['name'] %></a><% end %> interest:<%= i['num_interest']%>:<%= sprintf("%.1f",i['avg_interest']) %>, approval:<%= i['num_approval'] %>:<%= sprintf("%.1f",i['avg_approval']) %>, value:<%= sprintf("%.1f",i['value'])  %>, <% if @less_more=='more' %>controversy: <%= sprintf("%.1f",i['controversy'])  %>,<% end %> ratings:<%= i['votes'] %><br>
<% break if not @all %>
<% end -%>
[<a href="/dialogs/<%= @dialog_id %>/forum?<%=raw @period_id > 0 ? "period_id=#{@period_id}&amp;" : "" %>sortby=*value*&amp;threads=root&amp;from=result" target="_blank">see all in the forum</a>]<br>
<br>
</div>

<% for metamap in @metamaps -%>

	<div>
	<% for metamap_node_id,metamap_node_name in @data[metamap.id]['nodes_sorted'] -%>
		<h3 title="<%= metamap_node_id %>">Voice of <%= metamap_node_name %></h3>
		<% if  @data[metamap.id]['postedby']['nodes'][metamap_node_id] and  @data[metamap.id]['postedby']['nodes'][metamap_node_id]['itemsproc'].length > 0 -%>			
			<% if @data[metamap.id]['matrix']['post_rate'][metamap_node_id][metamap_node_id] -%>
				<% for item_id,i in @data[metamap.id]['matrix']['post_rate'][metamap_node_id][metamap_node_id]['itemsproc'] -%>
				<a href="/items/<%= item_id %>/view" style="font-size:14px;font-weight:bold"><%= i['subject'] || "no subject" %></a> <% if @less_more=='more' %>author: <a href="/participant/<%= i['id'] %>/profile"><%= i['name'] %></a><% end %> interest:<%= i['num_interest']%>:<%= sprintf("%.1f",i['avg_interest']) %>, approval:<%= i['num_approval'] %>:<%= sprintf("%.1f",i['avg_approval']) %>, value:<%= sprintf("%.1f",i['value']) %>, <% if @less_more=='more' %>controversy: <%= sprintf("%.1f",i['controversy'])  %>,<% end %> ratings:<%= i['votes'] %><br>
				<% break if not @all %>
				<% end -%>
			<% else -%>
				no positive results<br>
			<% end -%>
			[<a href="/dialogs/<%= @dialog_id %>/forum?<%=raw @period_id > 0 ? "period_id=#{@period_id}&amp;" : "" %>sortby=*value*&amp;threads=root&amp;from=result&amp;posted_by_metamap_<%= metamap.id %>=<%= metamap_node_id %>&amp;rated_by_metamap_<%= metamap.id %>=<%= metamap_node_id %>" target="_blank">see all in the forum</a>]<br>
		<% else -%>
			no results<br>
		<% end -%>
		<br>
		
	<% end -%>
	<br>
	</div>

<% end -%>

<script>
function updatemeta() {
	var period_id = $('#period_id').val();
	window.location.href = "?period_id=" +  period_id;
}
function reload() {
	var short_full = $('#short_full').val();
	var less_more = $('#less_more').val();
	var regress = $('#regress').val();
	var period_id = <%= @period_id > 0 ? @period_id.to_i : 0 %>;
	if (short_full=='short') {
		$('#less_more').hide();
		$('#regress').hide();
	} else {
		$('#less_more').show();
		$('#regress').show();
	}
	window.location.href = "?period_id=" + period_id + "&short_full=" +  short_full + '&less_more=' + less_more + '&regress=' + regress;	
}
</script>
