<%= render(:partial => 'dialogs/menu') %>
<% logger.info("dialogs#slider slider.html") %>

<div id="slider_container" style="overflow:none;width:740px;min-height:600px">

  <div style="float:left;width:595px;min-height:600px">

    <div id="per_main" style="width:595px;min-height:600px">
  
      loading...
        
    </div>
    
    <% if @in == 'network' and @network -%>
    <div>
      <br>
      <h3>Communities in this network:</h3>
      <ul>
      <% for com in @network.communities -%>
        <% if com.active -%>
          <li><%= com.tagname %></li>
        <% end -%>
      <% end -%>
      </ul>
    </div>
    <% end -%>
  
    <input type="hidden" id="sortby" value="<%= @sortby %>">
    <input type="hidden" id="threads" value="<%= @threads %>">
    <input type="hidden" id="datefixed" value="<%= @datefixed %>">
    <input type="hidden" id="comtag" value="<%= @comtag %>">
    <input type="hidden" id="messtag" value="<%= @messtag %>">    
    
  </div>

  <div style="float:left;width:139px;padding-left:5px;" id="right_sidebar">
  
    <p>
        <% if (not @conversation) or (@conversation and @is_conv_member) %>
          <input type="button" value="<%= @dialog.new_message_title.to_s != '' ? @dialog.new_message_title : "Add Message" %>" id="newthreadbutton" onclick="newitem('<%= form_authenticity_token %>')">
          <input type="button" value="Add My Question" id="newthreadbutton" onclick="newitem('<%= form_authenticity_token %>','question')">
    		<% end -%>
        
        <% if @showing_options == 'more' -%>
          <input type="button" value="Hide Options" style="margin-top:10px" id="options_button" onclick="chg_options()">        
        <% else -%>
          <input type="button" value="Options" style="margin-top:10px" id="options_button" onclick="chg_options()">
        <% end -%>
      </p>

    <div style="margin: 20px 0 0 0;">
      <img src="/images/<%= @nvaction ? 'exitaction' : 'nvaction' %>.jpg" id="actionbutton" onclick="actionclick()" alt="NV action button">
    </div>
    
    <% if false -%>
      <% if @include_nvaction -%>
        <button style="margin-top:10px;<%="display:none" if @nvaction %>" id="nvaction_include_button" onclick="chg_nvaction_include()">NV Action items<br>are included</button>  
      <% else -%>
        <button style="margin-top:10px;<%="display:none" if @nvaction %>" id="nvaction_include_button" onclick="chg_nvaction_include()">NV Action items<br>are excluded</button>
      <% end -%>
    <% end -%>
    
    <% if @in == 'conversation' and @conversation and @conversation.topics.class.name == 'Array' and @conversation.topics.length > 0 -%>
    <div style="margin: 20px 0 0 0;">
        <b>Topic:</b><br>
        <input type="radio" name="topic_radio" value="" <%= (@topic.to_s == '*' or (@topic.to_s == '' and @conversation.default_topic.to_s == '')) ? "checked" : "" %> onclick="per_reload()">any topic<br>
        <% @conversation.topics.each do |topic| -%>
          <input type="radio" name="topic_radio" value="<%= topic %>" <%= (topic == @topic or (@topic.to_s == '' and topic == @conversation.default_topic.to_s)) ? "checked" : "" %> onclick="per_reload()"><%=topic %><br>
        <% end -%>
      </div>
      <div style="text-align:center;margin:4px 25px 4px 0">-----</div>
    <% end -%>
    
    <div style="margin: 20px 0 0 0;">
    <% freeze_geo = false %>
    <% if @in == 'network' and @network and @network.geo_level.to_i > 0 %>
      <% @geo_level = @network.geo_level  %>
      <% freeze_geo = true %>
    <% end -%>
    <% @geo_levels.each do |geo_level,geo_desc| -%>
      <input type="radio" name="geo_level_radio" value="<%= geo_level %>" <%= geo_level == @geo_level ? "checked" : "" %> <% if freeze_geo %>disabled<% end %> onclick="per_reload()"><%=raw geo_desc %><br>  
    <% end -%>
    </div>
    
    <div style="text-align:center;margin:4px 25px 4px 0">-----</div>
    
    <div style="display: <%= @in == 'conversation' ? 'none' : 'block' -%>">
      <% if @in == 'network' -%>
        <input type="radio" name="comtag_radio" value="" onclick="per_reload(false,1,'comtag')" <%= @comtag.to_s=='' ? "checked" : "" %>>any community<br>
        <input type="radio" name="comtag_radio" value="*my*" onclick="per_reload(false,1,'comtag')" <%= @comtag.to_s=='*my*' ? "checked" : "" %>>my communities<br>
        <% current_participant.tags.each do |tag| -%>
          <% if @network and @network.communities.collect{|com| com.tagname }.include? tag.name -%>
            <input type="checkbox" name="comtag_radio" value="<%= tag.name %>" checked disabled>@<%= tag.name %><br> 
          <% else -%>
            <input type="radio" name="comtag_radio" value="<%= tag.name %>" <%= (tag.name == @comtag.to_s) ? "checked" : "" %> onclick="per_reload(false,1,'comtag')">@<%= tag.name %><br> 
          <% end -%>
        <% end %>              
      <% else -%>
        <input type="radio" name="comtag_radio" value="" onclick="per_reload(false,1,'comtag')" <%= @comtag.to_s=='' ? "checked" : "" %>>any community<br>
        <% if @comtag.to_s != '' and @comtag != '*my*' and not current_participant.tag_list.include?(@comtag) -%>
        <input type="radio" name="comtag_radio" value="<%= @comtag %>" onclick="per_reload(false,1,'comtag')" checked>@<%= @comtag %><br>
        <% end -%>
        <input type="radio" name="comtag_radio" value="*my*" onclick="per_reload(false,1,'comtag')" <%= @comtag.to_s=='*my*' ? "checked" : "" %>>my communities<br> 
        <% current_participant.tags.each do |tag| -%>
          <% community = Community.find_by_tagname(tag.name) %>
          <% if community and community.active -%>
            <input type="radio" name="comtag_radio" value="<%= tag.name %>" <%= (tag.name == @comtag.to_s) ? "checked" : "" %> onclick="per_reload(false,1,'comtag')">@<%= tag.name %><br> 
          <% end -%>
        <% end %>
      <% end %>
      <div style="text-align:center;margin:4px 25px 4px 0">-----</div>
    </div>
    
  
    <div style="display: <%= @in == 'conversation' ? 'none' : 'block' -%>">
      <input type="radio" name="messtag_radio" value="" onclick="per_reload(false,1,'messtag')" <%= @messtag.to_s=='' ? "checked" : "" %>>any hashtag<br>
      <% if @messtag.to_s != '' and not current_participant.tag_list.include?(@messtag) -%>
      <input type="radio" name="messtag_radio" value="<%= @messtag %>" onclick="per_reload(false,1,'messtag')" checked>#<%= @messtag %><br>
      <% elsif @comtag.to_s != '' and @comtag != '*my*' and not current_participant.tag_list.include?(@comtag) -%>
      <input type="radio" name="messtag_radio" value="<%= @comtag %>" onclick="per_reload(false,1,'messtag')" checked>#<%= @comtag %><br>
      <% end -%>
      <% current_participant.tags.each do |tag| -%>
        <% community = Community.find_by_tagname(tag.name) %>
        <% if community and community.active -%>
          <% if @network and @network.communities.collect{|com| com.tagname }.include? tag.name -%>
            <input type="checkbox" name="messtag_radio" value="<%= tag.name %>" checked disabled>#<%= tag.name %><br>
          <% else -%>
            <input type="radio" name="messtag_radio" value="<%= tag.name %>" <%= (tag.name == @messtag.to_s) ? "checked" : "" %> onclick="per_reload(false,1,'messtag')">#<%= tag.name %><br>
          <% end -%>
        <% end -%>
      <% end %>
      <% if false -%>
      <input type="radio" name="messtag_radio" value="*other*" onclick="per_reload(false,1,'messtag')">
      <% end -%>
      <div style="padding-left: 8px">& #<input type="text" id="messtag_other" size="10" maxlength="14" onchange="per_reload(false,1,'messtag_other')"></div>
      <div style="text-align:center;margin:4px 25px 4px 0">-----</div>
    </div>

    <div style="">
      <% gender = 0 %>
      <% freeze_gender = false %>
      <% if @in == 'network' and @network and @network.gender.to_i > 0 %>
        <% gender = @network.gender  %>
        <% freeze_gender = true %>
      <% end -%>
      <input type="radio" name="meta_3" id="meta_3_0" value="0" <% if gender==0 %>checked<% end %> <% if freeze_gender %>disabled<% end %> onclick="per_reload()">all<br>
      <% for metamap_node in MetamapNode.where(:metamap_id=>3).order(:sortorder) %>
        <% if not metamap_node.sumcat -%>
          <% if false %>
            <input type="checkbox" name="meta_3[]" id="meta_3_<%= metamap_node.id %>" value="<%= metamap_node.id %>" checked onclick="per_reload()"><%= metamap_node.name %><br>
          <% else %>
            <input type="radio" name="meta_3" id="meta_3_<%= metamap_node.id %>" value="<%= metamap_node.id %>" <% if metamap_node.id==gender %>checked<% end %> <% if freeze_gender %>disabled<% end %> onclick="per_reload()"><%= metamap_node.name %><br>
          <% end -%>
        <% end %>
      <% end %>
    </div>

    <div style="text-align:center;margin:4px 25px 4px 0">-----</div>

    <div style="">
      <% age = 0 %>
      <% freeze_age = false %>
      <% if @in == 'network' and @network and @network.age.to_i > 0 %>
        <% age = @network.age  %>
        <% freeze_age = true %>
      <% end -%>
      <input type="radio" name="meta_5" id="meta_5_0" value="0" <% if age==0 %>checked<% end %> <% if freeze_age %>disabled<% end %> onclick="per_reload()">all<br>
      <% for metamap_node in MetamapNode.where(:metamap_id=>5).order(:sortorder) %>
        <% if not metamap_node.sumcat -%>
          <input type="radio" name="meta_5" id="meta_5_<%= metamap_node.id %>" value="<%= metamap_node.id %>" <% if metamap_node.id==age %>checked<% end %> <% if freeze_age %>disabled<% end %> onclick="per_reload()"><%= metamap_node.name %><br>
        <% end %>
      <% end %>
    </div>

    <div style="display:none;margin: 20px 0 0 0;">
      <input type="radio" name="show_result" value="0" <%= @show_result.to_i == 0 ? "checked" : "" %> onclick="per_reload(undefined,undefined,'show_result')">Listing<br>
      <input type="radio" name="show_result" value="1" <%= @show_result.to_i == 1 ? "checked" : "" %> onclick="per_reload(undefined,undefined,'show_result')">Results
    </div>
  
  </div>

</div>

<input type="hidden" name="network_id" id="network_id" value="<%= @network_id %>">
<input type="hidden" name="conversation_id" id="conversation_id" value="<%= @conversation_id %>">
<input type="hidden" name="dialog_id" id="dialog_id" value="<%= @dialog_id %>">
<input type="hidden" name="in_dialog_id" id="in_dialog_id" value="<%= @dialog_id %>">
<input type="hidden" id="in_conversation" value="<%= @conversation_id.to_i > 0 ? 1 : 0 %>">
<input type="hidden" id="perspective" value="<%= @perspective.to_s %>">
<input type="hidden" name="geo_level" id="geo_level" value="1">
<input type="hidden" name="batch_level" id="batch_level" value="<%= (@batch_level || 1).to_i %>">
<input type="hidden" name="batch_size" id="batch_size" value="<%= (@batch_size || 4).to_i %>">
<input type="hidden" id="from" name="from" value="geoslider">
<input type="hidden" id="insection" name="insection" value="<%= @in %>">
<input type="hidden" name="top_posts" id="top_posts" value="<%= @top_posts.to_i %>">
<input type="hidden" name="is_first" id="is_first" value="<%= @is_first ? '1' : '0' %>">

<input type="hidden" id="cur_moon_new_new" value='<%= @cur_moon_new_new %>'>
<input type="hidden" id="cur_moon_full_full" value='<%= @cur_moon_full_full %>'>
<input type="hidden" id="cur_moon_new_full" value='<%= @cur_moon_new_full %>'>
<input type="hidden" id="cur_moon_full_new" value='<%= @cur_moon_full_new %>'>
<input type="hidden" id="cur_half_moon" value='<%= @cur_half_moon %>'>
<input type="hidden" id="lastmoon" value='<%= @lastmoon %>'>

<div id="newforumitem" class="newforumitem" style="display:none"></div>


<script>
var geo_levels = {1: 'city', 2: 'county', 3: 'metro', 4: 'state', 5: 'nation', 6: 'planet'};
var cur_comtag = '';
var cur_messtag = '';
var cur_geo_level = <%= @geo_level > 0 ? @geo_level : 5 %>;
var cur_topic = '';
var cur_batch_level = <%= (@batch_level || 1).to_i %>;
var cur_batch_size = <%= (@batch_size || 4).to_i %>;
var showing_options = '<%= @showing_options %>';
var user_comtags = <%=raw current_participant.tag_list.inspect %>;
var nvaction_on = <%= @nvaction ? 'true' : 'false' %>;
//var nvaction_included = <%= @include_nvaction ? 'true' : 'false' %>;;
var conversation_id = <%= @conversation_id.to_i %>;
var in_conversation = <%= @in_conversation ? 1 : 0 %>;
var perspective = '<%= @perspective.to_s %>';
var cur_conv = '<%= @conversation ? @conversation.shortname : '' %>';
var insection = '<%= @in %>';
var network_id = <%= @network_id.to_i %>;

$(function() {
  if (false) {
    $( "#geoslider" ).slider({
      orientation: "vertical",
      range: "min",
      min: 1,
      max: 5,
      value: cur_geo_level,
      slide: function( event, ui ) {
        cur_geo_level = ui.value;
        $( "#geo_level" ).val( cur_geo_level );
        per_reload();
      }
    });
    $( "#geo_level" ).val( $( "#geoslider" ).slider( "value" ) );
  }
});
var messtag_changed = false;
var add_after_reload = false;
function per_reload(first,num,whatchanged,page,go_item) {
  console.log('per_reload() whatchanged:'+whatchanged);
	if (editingid>0) {
	    alert("Please save or cancel the edit that is in progress");
	    return;
	} else if (replyingid>0) {
	    alert("Please save or cancel the reply that is in progress");
	    return;
	} else if (in_new_item>0) {
	    alert("Please save or cancel the new thread that is in progress");
	    return;
	}
  if (first === undefined) {
    first = false;
  } 
  first = first ? 1 : 0;
  if (num === undefined) {
    num = 2;
  }
  if (page === undefined) {
    page = 1;
  }
  if (go_item === undefined) {
    go_item = 0;
  }

 	$('#per_main').css('opacity','0.5');
  cur_comtag = $("input[name='comtag_radio']:checked").val();
  
  if (whatchanged=='messtag') {
    cur_messtag = $("input[name='messtag_radio']:checked").val(); 
    if (cur_messtag == '') {
      messtag_changed = false;
    } else {
      messtag_changed = true;
    }  
  }
  
  if (whatchanged=='comtag' && !messtag_changed && $.inArray(cur_comtag, user_comtags) > -1) {
    var xfound = false;
    $("input[name=messtag_radio]").each(function(i) {
      if ($(this).val()==cur_comtag) {
        $(this).prop('checked', true);
        xfound = true;
      }
    });
    //if (!xfound) {
    //  $('#messtag_other').val(cur_comtag);
    //  $("input[name=messtag_radio][value='*other*']").prop('checked', true);
    //}
  }  

  cur_messtag = $("input[name='messtag_radio']:checked").val();
  messtag_other = $('#messtag_other').val();
  
  //if (cur_messtag == '*other*') {
  //  cur_messtag = $('#messtag_other').val();
  //}
  if (cur_messtag == '') {
    $("input[name=messtag_radio][value='']").prop('checked', true);
  }
  cur_geo_level = $("input[name='geo_level_radio']:checked").val();
   
  cur_topic =  $("input[name='topic_radio']:checked").val();
   
  var showratings = <%= params[:showratings].to_i == 1 ? 1 : 0 %>;
  var showfollow = <%= params[:showfollow].to_i == 1 ? 1 : 0 %>;
  
  var show_result = $('input[name=show_result]:checked').val();
  var top_posts = $('#top_posts').val();
  var is_first = $('#is_first').val();
  //checkbox
  //var meta_3 = $("input[name='meta_3[]']:checked").map(function(){
  //  return $(this).val();
  //}).get();
  var meta_3 = $("input[name='meta_3']:checked").val()
  var meta_5 = $("input[name='meta_5']:checked").val()
  var dialog_id = $('#dialog_id').val();
   var conversation_id = $('#conversation_id').val();
  //var comtag = $('#comtag').val()
  var comtag = cur_comtag;
  var messtag = cur_messtag;
  var topic = cur_topic;
  if (first) {
    var threads = $('#threads').val();
    var sortby = $('#sortby').val();    
    var datefixed = $('#datefixed').val();   
  } else {
    var threads = $('#threads'+num).val();
    var sortby = $('#sortby'+num).val();
    var datefixed = $('#datefixed'+num).val();
    var othernum = (num==2) ? 1 : 2;
    $('#threads'+othernum).val(threads);
    $('#sortby'+othernum).val(sortby);
    $('#datefixed'+othernum).val(datefixed);
    $('#threads').val(threads);
    $('#sortby').val(sortby);
    $('#datefixed').val(datefixed);
  }
  var nvaction = nvaction_on ? 1 : 0
  $('#newthreadbutton').prop('disabled', false);
  var data = {page: page, geo_level: cur_geo_level, batch_level: cur_batch_level, batch_size: cur_batch_size, dialog_id: dialog_id, meta_3: meta_3, meta_5: meta_5, show_result: show_result, top_posts: top_posts, threads: threads, sortby: sortby, first: first, showing_options: showing_options, datefixed: datefixed, comtag: comtag, messtag: messtag, messtag_other: messtag_other, showratings: showratings, showfollow: showfollow, nvaction: nvaction, conversation_id: conversation_id, in_conversation: in_conversation, perspective: perspective, in: insection, network_id: network_id, topic: topic, is_first: is_first, authenticity_token: '<%= form_authenticity_token %>'}
  
  //nvaction_included: (nvaction_included ? 1 : 0),
  
  //var tag;
  //$('.com_check').each(function(i) {
  //  if ($(this).val()=='1') {
  //    tag = $(this).data('tag');
  //    data['check['+tag+']'] = 1
  //  }
  //});
  
  if (whatchanged !== undefined) {
    data['whatchanged'] = whatchanged;
  }
	$.ajax({
    type: 'POST',
	  url: '/items/geoslider_update',
	  data: data,
	  complete: function(t){ 
      $('#per_main').css('opacity','1.0');
  	  $('#per_main').html(t.responseText);
      $('#maincontent').height( $('#per_main').height()+95 );
  		if (go_item>0) {
  			location.href = "#"+go_item;
  		} else {
        	$(window).scrollTop(0);
  		}
      if (add_after_reload) {
        newitem('<%= form_authenticity_token %>');
      }
	  }
	});	
}
per_reload(true);
function chg_options() {
  if (showing_options=='more') {
    $('#options_top').hide();
    showing_options = 'less';
    $('#options_button').val("Options");
  } else {
    $('#options_top').show();
    showing_options = 'more';
    $('#options_button').val("Hide Options");
  }
}
function chg_nvaction_include() {
  if (nvaction_included) {
    nvaction_included = false;
    $('#nvaction_include_button').html("NV Action items<br>are excluded");
  } else {
    nvaction_included = true;
    $('#nvaction_include_button').html("NV Action items<br>are included");
  }
  per_reload();
}
function gotopage(page) {
	per_reload(false,1,'page',page)
}
function joinleave(comtag) {
  var which = $('#comtagjoin').prop('value');
  var data = {
    'comtag': comtag,
    'which': which,
  };
	$.ajax({
    type: 'GET',
	  url: '/me/comtag',
	  data: data,
	  complete: function(t){ 
      if (which=='join') {
        $('#comtagjoin').prop('value','leave');
      } else {
        $('#comtagjoin').prop('value','join');
      }
      window.location.href = '?comtag='+comtag;
	  }
	});
}
function actionclick() {
  if (nvaction_on) {
    nvaction_on = false;
    $('#actionbutton').attr('src','/images/nvaction.jpg');
    $('#top_forum_header').html('Forum');
    $('#top_result_header').html('Highest Rated Messages');
    $('#nvaction_include_button').show();
  } else {
    nvaction_on = true;
    $('#actionbutton').attr('src','/images/exitaction.jpg');
    $('#top_forum_header').html('Nonviolent Action Forum');
    $('#top_result_header').html('Highest Rated Nonviolent Action Items');
    $('#nvaction_include_button').hide();
    nvaction_included = false;
  }
  per_reload();
}
function chg_conversation() {
  var conv = $('#chg_conv').val();
  if (conv != '') {
    // Might be a - to leave the conversation (and go to community)
    window.location.href = '?conv='+conv;
  }
}
function leave_conversation() {
  window.location.href = '?comtag='+cur_comtag+'&conv=-';  
}
function chg_community() {
  var com = $('#chg_com').val();
  if (com != '') {
    window.location.href = '?comtag='+com+'&conv='+cur_conv+'<%= @show_result==1 ? "&show_result=1" : "" %>';
  }
}
function load_thread(item_id, conversation_id) {
  // Load a thread (maybe with comments) into the main part of the screen, not in a different screen
  $('#per_main').css('opacity','0.5');
	$.ajax({
    type: 'GET',
	  url: '/items/'+item_id+'/thread?inline=1&conversation_id='+conversation_id,
	  complete: function(t){ 
      $('#per_main').css('opacity','1.0');
  	  $('#per_main').html(t.responseText);
      $('#maincontent').height( $('#per_main').height()+95 );
      $(window).scrollTop(0);
	  }
	});	
}

</script>